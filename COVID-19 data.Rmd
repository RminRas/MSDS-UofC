---
title: "COVID19 Data"
author: ""
date: ""
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
```

## COVID-19 Data Import

This document's created to analyze COVID-19 Data published by Johns Hopkins University  available through  <https://github.com/CSSEGISandData/COVID-19>.

This Markdown uses **tidyverse** and **lubridate** R Packages.

```{r import_data, eval=TRUE, message=FALSE}
url_in <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/"
file_names <- c("time_series_covid19_confirmed_US.csv",  "time_series_covid19_confirmed_global.csv", "time_series_covid19_deaths_US.csv",  "time_series_covid19_deaths_global.csv")
urls <- str_c(url_in,file_names)
US_cases <- read_csv(urls[1])
global_cases <- read_csv(urls[2])
US_deaths <- read_csv(urls[3])
global_deaths <- read_csv(urls[4])
uid <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/UID_ISO_FIPS_LookUp_Table.csv") %>% select(-c(Lat, Long_, Combined_Key, code3, iso2, iso3, Admin2)) #for global population data 
```

## Data Cleaning and Wrangling

Now let's tidy up our data, putting it in the long format and joining both deaths and cases counts for global and US data sets:

```{r , message=FALSE}
global_cases <- global_cases %>% pivot_longer(cols = -c(`Province/State`,`Country/Region`,Lat,Long), names_to = "date", values_to = "cases") %>% select(-c(Lat,Long))

global_deaths <- global_deaths %>% pivot_longer(cols = -c(`Province/State`,`Country/Region`,Lat,Long), names_to = "date", values_to = "deaths") %>% select(-c(Lat,Long))

global <- global_cases %>% full_join(global_deaths) %>% rename(Country_Region = `Country/Region`, Province_State = `Province/State`) %>% mutate(date = mdy(date))

global <- global %>% filter(cases>0) #Focusing from the point of counting cases

global <- global %>% unite("Combined_Key", c(Province_State, Country_Region), sep = ", ", na.rm = TRUE, remove = FALSE) #Adding Combined Key in the similar format as US data

global <- global %>% left_join(uid, by = c("Province_State", "Country_Region")) %>% 
select(-c(UID, FIPS)) %>% 
select(Province_State, Country_Region, date, cases, deaths, Population, Combined_Key) #Adding Population data

US_cases <- US_cases %>% pivot_longer(cols = -(UID:Combined_Key), names_to = "date", values_to = "cases") %>% select(Admin2:cases) %>% mutate(date = mdy(date)) %>% select(-c(Lat,Long_))

US_deaths <- US_deaths %>% pivot_longer(cols = -(UID:Population), names_to = "date", values_to = "deaths") %>% select(Admin2:deaths) %>% mutate(date = mdy(date)) %>% select(-c(Lat,Long_))

US <- US_cases %>% full_join(US_deaths)
```

Now let's take a look at a summary of global and US tibbles:

```{r}
summary(global)
summary(US)
```

## Visaulizations & Analysis

Grouping US data by State, calculating to total cases and deaths/deaths per mill as well as population:

```{r, message=FALSE}
US_by_state <- US %>% group_by(Province_State, Country_Region, date) %>% summarize(cases = sum(cases), deaths = sum(deaths), Population = sum(Population)) %>% mutate(deaths_per_mill = deaths *1000000 / Population) %>% select(Province_State, Country_Region, date, cases, deaths, deaths_per_mill, Population) %>% ungroup()

US_totals <- US_by_state %>% group_by(Country_Region, date) %>% summarize(cases = sum(cases), deaths = sum(deaths), Population = sum(Population)) %>% mutate(deaths_per_mill = deaths*100000 / Population) %>% ungroup()
```

Adding to columns for new cases and new deaths:

```{r, message=FALSE}
US_by_state <- US_by_state %>% mutate(new_cases = cases - lag(cases), new_deaths = deaths - lag(deaths))

US_totals <- US_totals %>% mutate(new_cases = cases - lag(cases), new_deaths = deaths - lag(deaths))
```

Let's see what states had the worst cases per thousand and deaths per thousand rates:

```{r}
US_state_totals <- US_by_state %>% group_by(Province_State) %>% summarize(deaths = max(deaths), cases = max(cases), population= max(Population), cases_per_thou = 1000* cases / population, deaths_per_thou = 1000 * deaths / population) %>% filter(cases > 0, population > 0)
US_state_totals %>% slice_max(deaths_per_thou, n = 10) %>% select(deaths_per_thou, cases_per_thou, everything())
```

as you can see *`r US_state_totals %>% slice_max(deaths_per_thou, n = 1) %>% pull(Province_State)`* and *`r US_state_totals %>% slice_max(deaths_per_thou, n = 2) %>% slice(2) %>% pull(Province_State)`* have the highest rates of deaths per thousand.

Now lets visualized what was the trend for cases and deaths for these two states:

```{r}
state <- US_state_totals %>% slice_max(deaths_per_thou, n = 1) %>% pull(Province_State)

US_by_state %>%
  filter(Province_State == state) %>%
  filter(cases > 0) %>%
  ggplot(aes(x = date, y = cases)) +
  geom_line(aes(color = "cases")) +
  geom_point(aes(color = "cases")) +
  geom_line(aes(y = deaths, color = "deaths")) +
  geom_point(aes(y = deaths, color = "deaths")) +
  scale_y_log10() +
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90)) +
  labs(title = str_c("COVID-19 in ", state), y = NULL)
```

```{r}
state <- US_state_totals %>% slice_max(deaths_per_thou, n = 2) %>% slice(2) %>% pull(Province_State)

US_by_state %>%
  filter(Province_State == state) %>%
  filter(cases > 0) %>%
  ggplot(aes(x = date, y = cases)) +
  geom_line(aes(color = "cases")) +
  geom_point(aes(color = "cases")) +
  geom_line(aes(y = deaths, color = "deaths")) +
  geom_point(aes(y = deaths, color = "deaths")) +
  scale_y_log10() +
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90)) +
  labs(title = str_c("COVID-19 in ", state), y = NULL)
```

Now these two graphs do not tell us what was the trend for new_cases and new_deaths as we progressed through the pandemic, for that we can use new_cases and new_deaths columns:

```{r, warning=FALSE}
state <- US_state_totals %>% slice_max(deaths_per_thou, n = 1) %>% pull(Province_State)

US_by_state %>%
  filter(Province_State == state) %>%
  filter(cases > 0) %>%
  ggplot(aes(x = date, y = new_cases)) +
  geom_line(aes(color = "new_cases")) +
  geom_point(aes(color = "new_cases")) +
  geom_line(aes(y = new_deaths, color = "new_deaths")) +
  geom_point(aes(y = new_deaths, color = "new_deaths")) +
  scale_y_log10() +
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90)) +
  labs(title = str_c("COVID-19 in ", state), y = NULL)
```

```{r, warning=FALSE}
state <- US_state_totals %>% slice_max(deaths_per_thou, n = 2) %>% slice(2) %>% pull(Province_State)

US_by_state %>%
  filter(Province_State == state) %>%
  filter(cases > 0) %>%
  ggplot(aes(x = date, y = new_cases)) +
  geom_line(aes(color = "new_cases")) +
  geom_point(aes(color = "new_cases")) +
  geom_line(aes(y = new_deaths, color = "new_deaths")) +
  geom_point(aes(y = new_deaths, color = "new_deaths")) +
  scale_y_log10() +
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90)) +
  labs(title = str_c("COVID-19 in ", state), y = NULL)
```

## Model

We can develop a model for the US new_deaths as a variable of new_cases for different states, to predict the relation between the two for each state:

```{r}
mod <- lm(new_deaths ~ new_cases + Province_State, data = US_by_state)
```

```{r}
summary(mod)
```

Now let's see how the prediction compares with actual data:

```{r}
US_by_state_estimate <- US_by_state %>% filter(!is.na(new_deaths)) %>% filter(!is.na(new_cases)) %>% mutate(pred = predict(mod))
```

Plotting the result for *`r US_state_totals %>% slice_max(deaths_per_thou, n = 1) %>% pull(Province_State)`* on a Log-Log scale graph:

```{r warning=FALSE}
US_by_state_estimate %>% filter(Province_State == US_state_totals %>% slice_max(deaths_per_thou, n = 1) %>% pull(Province_State)) %>% ggplot()+ geom_point(aes(x= new_cases, y = new_deaths), color = "blue") + geom_point(aes(x = new_cases, y = pred), color = "red") + scale_x_log10() + scale_y_log10()
```

As you can see there are a lot of outliers in the data for *`r US_state_totals %>% slice_max(deaths_per_thou, n = 1) %>% pull(Province_State)`*, but in general the model tries to find the best line that would fit the relation between new cases and new deaths.

## Sources of Bias & Conclusion

There are some sources of bias here, the first one is the quality of tests being done and the vastness of testing for new cases. Some states might test extensively some may not and that could impact the results. Also, another factor and source of bias comes from demographics of each state, the age groups the racial information and also the level healthcare provided for new cases. These could all impact the relationship between new cases and deaths.

Overall what we have done here was to see the trend over time of cases and deaths, find the states with most deaths per thousand rates, see the trends for their cases and deaths overtime, and at the end we developed a linear model for new_deaths based on new_cases and the state. We then compared the model for *`r US_state_totals %>% slice_max(deaths_per_thou, n = 1) %>% pull(Province_State)`* and compared the predictions with the actual data. The sources of bias here would impact the prediction and we need more demographic information to improve the model and make it more accurate.

## Session Info 

```{r, eval=TRUE, echo=FALSE}
sessionInfo()
```
